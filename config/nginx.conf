# Nginx configuration for Blossom Espelhator Tabajara
# This file is mounted into the nginx container

user nginx;
worker_processes auto;
error_log /dev/stderr warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Real IP configuration for running behind a reverse proxy
    # Trust proxies in private networks and Cloudflare IPs
    # Add your reverse proxy IPs/subnets here
    set_real_ip_from 0.0.0.0/0;
    set_real_ip_from ::/0;
    
    # Use X-Forwarded-For header to get real client IP
    real_ip_header X-Forwarded-For;
    # Use the last IP in X-Forwarded-For chain (the original client)
    real_ip_recursive on;

    # Logging format - includes real client IP
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    # Enhanced logging format with more details
    log_format detailed '$remote_addr ($http_x_forwarded_for) - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_real_ip" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time" '
                        'upstream="$upstream_addr"';

    access_log /dev/stdout main;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    server_tokens off;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # Rate limiting zones - use real client IP from X-Forwarded-For
    # Create a map to extract real IP for rate limiting
    map $http_x_forwarded_for $real_client_ip {
        default $remote_addr;
        ~^([^,]+) $1;
    }
    
    # Map to control logging - returns 0 (don't log) for localhost health checks, 1 otherwise
    map "$remote_addr:$request_uri" $loggable {
        default 1;
        "127.0.0.1:/health" 0;
        "::1:/health" 0;
        "localhost:/health" 0;
    }
    
    # Limit requests per real client IP
    limit_req_zone $real_client_ip zone=api_limit:10m rate=10r/s;
    # Limit connections per real client IP
    limit_conn_zone $real_client_ip zone=conn_limit:10m;

    # Upstream server configuration
    upstream blossom_backend {
        server blossom-espelhator:7624;
        keepalive 32;
    }

    server {
        listen 7624;
        server_name _;

        # Connection limits
        limit_conn conn_limit 20;

        # Health check endpoint (rate limited, same as stats)
        location = /health {
            limit_req zone=api_limit burst=5 nodelay;
            # Conditional logging - skip logs for localhost health checks
            access_log /dev/stdout main if=$loggable;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            # Pass real client IP (from X-Forwarded-For if available, otherwise remote_addr)
            proxy_set_header X-Real-IP $real_client_ip;
            # Preserve original X-Forwarded-For chain, or set if not present
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Stats endpoint (rate limited)
        location = /stats {
            limit_req zone=api_limit burst=5 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Home page (rate limited, same as stats)
        location = / {
            limit_req zone=api_limit burst=5 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Upload endpoint (more lenient rate limiting for large files)
        location = /upload {
            limit_req zone=api_limit burst=3 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Disable request buffering to enable streaming uploads
            # This allows the backend to start processing uploads immediately
            # as data arrives, preventing auth header expiration on large files
            proxy_request_buffering off;
            
            # Increase timeouts for large uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            send_timeout 300s;
        }

        # Mirror endpoint
        location = /mirror {
            limit_req zone=api_limit burst=3 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Disable request buffering to enable streaming (mirror requests can also be large)
            proxy_request_buffering off;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # List endpoint
        location ~ ^/list/ {
            limit_req zone=api_limit burst=5 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Download/Delete endpoints (hash-based paths)
        # Matches /<64-hex-chars> or /<64-hex-chars>.<extension>
        location ~ ^/[0-9a-fA-F]+(\.[a-zA-Z0-9]+)?$ {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://blossom_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $real_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Don't buffer responses for downloads
            proxy_buffering off;
        }

        # Default location - return 404 for unmatched paths
        location / {
            return 404;
        }

        # Error pages
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
