# Blossom Proxy Server Configuration

# Upstream Blossom servers to forward uploads to
# At least min_upload_servers must be configured
upstream_servers:
  - url: "https://blossom1.example.com"
    priority: 1
    supports_mirror: true          # BUD-04: Mirroring endpoint (PUT /mirror)
    supports_upload_head: true     # BUD-06: Upload preflight (HEAD /upload)
  - url: "https://blossom2.example.com"
    priority: 2
    supports_mirror: false         # This server doesn't support mirror
    supports_upload_head: true
  - url: "https://blossom3.example.com"
    priority: 3
    # If not specified, defaults to false (optional endpoints are opt-in)

# Proxy server configuration
server:
  # Address to listen on (format: host:port or :port)
  listen_addr: ":8080"
  
  # Minimum number of upstream servers that must successfully receive an upload
  # If fewer servers succeed, the upload will fail
  min_upload_servers: 2
  
  # Strategy for selecting which upstream server to redirect to for downloads
  # Options: "round_robin", "random", "health_based", "priority", "local"
  # - "round_robin": Cycles through available servers
  # - "random": Randomly selects from available servers
  # - "health_based": Uses round-robin (health checking not yet implemented)
  # - "priority": Selects server with lowest priority number (lower is better)
  # - "local": Returns local URL (base_url/sha256.ext) where base_url is derived from request
  #            and ext is derived from mime type or file extension
  redirect_strategy: "round_robin"
  
  # Timeout for upstream server requests
  timeout: 30s
  
  # Maximum number of retries for failed requests
  max_retries: 3
  
  # Health check configuration
  # Maximum consecutive failures before marking a server as unhealthy
  # If a server exceeds this threshold, it is marked unhealthy
  max_failures: 5
  
  # Maximum number of goroutines before marking system unhealthy
  max_goroutines: 1000
  
  # Maximum memory usage in bytes before marking system unhealthy
  # Default: 512 MB (512 * 1024 * 1024 bytes)
  max_memory_bytes: 536870912
