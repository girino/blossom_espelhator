# Blossom Proxy Server Configuration

# Upstream Blossom servers to forward uploads to
# At least min_upload_servers must be configured
upstream_servers:
  - url: "https://blossom1.example.com"
    priority: 1
    supports_mirror: true          # BUD-04: Mirroring endpoint (PUT /mirror)
    supports_upload_head: true     # BUD-06: Upload preflight (HEAD /upload)
  - url: "https://blossom2.example.com"
    priority: 2
    supports_mirror: false         # This server doesn't support mirror
    supports_upload_head: true
  - url: "https://blossom3.example.com"
    priority: 3
    # If not specified, defaults to false (optional endpoints are opt-in)

# Proxy server configuration
server:
  # Address to listen on (format: host:port or :port)
  listen_addr: ":8080"
  
  # Minimum number of upstream servers that must successfully receive an upload
  # If fewer servers succeed, the upload will fail
  min_upload_servers: 2
  
  # Strategy for selecting which upstream server to redirect to for downloads
  # Options: "round_robin", "random", "health_based", "priority", "local"
  # - "round_robin": Cycles through available servers
  # - "random": Randomly selects from available servers
  # - "health_based": Selects from servers with the least total failures, using round-robin for ties
  # - "priority": Selects server with lowest priority number (lower is better)
  # - "local": For downloads, uses round-robin to select an upstream server for redirection.
  #            For upload/mirror/list responses, returns local URL (base_url/sha256.ext).
  redirect_strategy: "round_robin"
  
  # Fallback redirect strategy specifically for GET (download) requests
  # If not set or empty, falls back to redirect_strategy
  # Options: same as redirect_strategy
  # This allows using a different strategy for downloads vs. uploads/mirrors/lists
  # Example: Use "priority" for downloads while using "health_based" for uploads
  # download_redirect_strategy: ""
  
  # Base URL for constructing local URLs (independent of redirect_strategy)
  # If set, this URL will be used when constructing local URLs (when redirect_strategy is "local")
  # If not set or empty, base URL will be derived from the request
  # Useful for reverse proxy scenarios where you want to force a specific public URL
  # Example: "https://blossom.example.com" or "http://localhost:8080"
  # Note: Only affects response URLs when redirect_strategy is "local", does not affect redirects
  base_url: ""
  
  # Timeout for upstream server requests (download/HEAD/DELETE operations)
  timeout: 30s
  
  # Minimum timeout for upload requests (used when expiration timestamp is missing or too short)
  # Default: 5m (5 minutes) if not specified
  # Recommended: Set based on your largest expected file size and upload speed
  # Example: For 100MB uploads at 10MB/s, use at least 20s, but add buffer for network variability
  min_upload_timeout: 5m
  
  # Maximum timeout for upload requests (caps the timeout calculated from expiration timestamp)
  # Default: 30m (30 minutes) if not specified
  # The upload timeout is calculated from the authorization header's expiration timestamp
  # but is clamped between min_upload_timeout (minimum) and max_upload_timeout (maximum)
  # This prevents extremely long timeouts while still allowing flexibility for large files
  max_upload_timeout: 30m
  
  # Maximum number of retries for failed requests
  max_retries: 3
  
  # Health check configuration
  # Maximum consecutive failures before marking a server as unhealthy
  # If a server exceeds this threshold, it is marked unhealthy
  max_failures: 5
  
  # Maximum number of goroutines before marking system unhealthy
  max_goroutines: 1000
  
  # Maximum memory usage in bytes before marking system unhealthy
  # Default: 512 MB (512 * 1024 * 1024 bytes)
  max_memory_bytes: 536870912
  
  # Cache configuration
  # Time-to-live for cache entries (how long entries stay in cache before expiring)
  # Default: 5m (5 minutes) if not specified
  # Cache entries are automatically removed after this duration
  # Example: "5m", "10m", "1h"
  cache_ttl: 5m
  
  # Maximum number of entries in the cache
  # Default: 1000 if not specified
  # When the cache reaches this size, the least recently used (LRU) entries are evicted
  # to make room for new entries
  cache_max_size: 1000
  
  # Authentication: List of allowed pubkeys (hex format or npub bech32 format)
  # If empty or not set, authentication is disabled
  # Authorization events must use kind 24242 per BUD-01
  # Only events from pubkeys in this list will be accepted
  # Both hex (64 characters) and npub (bech32) formats are supported
  # Example:
  #   - "b53185b9f27962ebdf76b8a9b0a84cd8b27f9f3d4abd59f715788a3bf9e7f75e"  # hex format
  #   - "npub1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"  # npub format
  allowed_pubkeys: []
